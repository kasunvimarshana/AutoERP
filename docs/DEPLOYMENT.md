# Deployment Guide

## Overview

This guide covers deploying the Modular SaaS Vehicle Service application to production environments.

## Prerequisites

- Linux server (Ubuntu 22.04 LTS recommended)
- PHP 8.2 or higher
- Composer 2.x
- MySQL 8.0+ or PostgreSQL 14+
- Node.js 18+ and npm
- Nginx or Apache
- Redis (optional, for caching and queues)
- SSL certificate

## Server Setup

### 1. Install Required Software

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install PHP and extensions
sudo apt install php8.2 php8.2-fpm php8.2-mysql php8.2-xml php8.2-mbstring \
  php8.2-curl php8.2-zip php8.2-gd php8.2-bcmath php8.2-redis -y

# Install Composer
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

# Install Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install nodejs -y

# Install MySQL
sudo apt install mysql-server -y
sudo mysql_secure_installation

# Install Nginx
sudo apt install nginx -y

# Install Redis (optional)
sudo apt install redis-server -y
```

### 2. Create Database

```bash
sudo mysql -u root -p
```

```sql
CREATE DATABASE vehicle_service_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'vehicle_service'@'localhost' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON vehicle_service_db.* TO 'vehicle_service'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3. Deploy Application

```bash
# Create application directory
sudo mkdir -p /var/www/vehicle-service
cd /var/www/vehicle-service

# Clone repository
git clone https://github.com/kasunvimarshana/ModularSaaS-LaravelVue.git .

# Set permissions
sudo chown -R www-data:www-data /var/www/vehicle-service
sudo chmod -R 755 /var/www/vehicle-service

# Install PHP dependencies
composer install --no-dev --optimize-autoloader

# Install Node dependencies and build assets
npm ci
npm run build

# Set up environment
cp .env.example .env
php artisan key:generate

# Configure .env file
nano .env
```

### 4. Configure .env for Production

```env
APP_NAME="Vehicle Service SaaS"
APP_ENV=production
APP_KEY=base64:... # Generated by artisan key:generate
APP_DEBUG=false
APP_URL=https://yourdomain.com

LOG_CHANNEL=stack
LOG_LEVEL=info

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=vehicle_service_db
DB_USERNAME=vehicle_service
DB_PASSWORD=strong_password

BROADCAST_DRIVER=redis
CACHE_DRIVER=redis
FILESYSTEM_DISK=local
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=smtp
MAIL_HOST=mailhog
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="noreply@yourdomain.com"
MAIL_FROM_NAME="${APP_NAME}"
```

### 5. Run Migrations

```bash
php artisan migrate --force
```

### 6. Optimize Application

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer dump-autoload --optimize
```

### 7. Configure Nginx

Create Nginx configuration:

```bash
sudo nano /etc/nginx/sites-available/vehicle-service
```

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    root /var/www/vehicle-service/public;
    index index.php index.html;

    # SSL Configuration
    ssl_certificate /etc/ssl/certs/yourdomain.com.crt;
    ssl_certificate_key /etc/ssl/private/yourdomain.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Logging
    access_log /var/log/nginx/vehicle-service-access.log;
    error_log /var/log/nginx/vehicle-service-error.log;

    # Client body size
    client_max_body_size 20M;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

Enable site:

```bash
sudo ln -s /etc/nginx/sites-available/vehicle-service /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 8. Set Up Queue Worker

Create systemd service:

```bash
sudo nano /etc/systemd/system/vehicle-service-worker.service
```

```ini
[Unit]
Description=Vehicle Service Queue Worker
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/var/www/vehicle-service
ExecStart=/usr/bin/php /var/www/vehicle-service/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
Restart=always
RestartSec=10s

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
sudo systemctl enable vehicle-service-worker
sudo systemctl start vehicle-service-worker
```

### 9. Set Up Scheduler

Add to crontab:

```bash
sudo crontab -e
```

```
* * * * * cd /var/www/vehicle-service && php artisan schedule:run >> /dev/null 2>&1
```

### 10. SSL Certificate

Using Let's Encrypt:

```bash
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com
```

## Monitoring

### Application Logs

```bash
tail -f /var/www/vehicle-service/storage/logs/laravel.log
```

### Nginx Logs

```bash
tail -f /var/log/nginx/vehicle-service-error.log
```

### Queue Status

```bash
php artisan queue:monitor
```

## Backup Strategy

### Database Backup

```bash
#!/bin/bash
# /usr/local/bin/backup-db.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/vehicle-service"
DB_NAME="vehicle_service_db"
DB_USER="vehicle_service"
DB_PASS="strong_password"

mkdir -p $BACKUP_DIR
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Keep only last 30 days
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +30 -delete
```

Schedule daily:

```bash
sudo crontab -e
```

```
0 2 * * * /usr/local/bin/backup-db.sh
```

## Updates and Maintenance

### Deploying Updates

```bash
cd /var/www/vehicle-service

# Put application in maintenance mode
php artisan down

# Pull latest changes
git pull origin main

# Update dependencies
composer install --no-dev --optimize-autoloader
npm ci && npm run build

# Run migrations
php artisan migrate --force

# Clear and rebuild cache
php artisan cache:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Restart services
sudo systemctl restart php8.2-fpm
sudo systemctl restart vehicle-service-worker

# Bring application back online
php artisan up
```

### Zero-Downtime Deployment

Use tools like:
- Laravel Envoyer
- Deployer
- GitHub Actions with deployment workflows

## Scaling

### Horizontal Scaling

1. Set up load balancer (Nginx, HAProxy, AWS ELB)
2. Deploy to multiple servers
3. Use shared session storage (Redis, Database)
4. Use shared file storage (S3, NFS)
5. Set up database read replicas

### Vertical Scaling

1. Increase server resources
2. Optimize MySQL configuration
3. Enable OPcache
4. Use Redis for caching
5. Enable HTTP/2 and Gzip

## Troubleshooting

### Permission Issues

```bash
sudo chown -R www-data:www-data /var/www/vehicle-service
sudo chmod -R 755 /var/www/vehicle-service
sudo chmod -R 775 /var/www/vehicle-service/storage
sudo chmod -R 775 /var/www/vehicle-service/bootstrap/cache
```

### Clear All Cache

```bash
php artisan optimize:clear
```

### Check System Status

```bash
php artisan about
```

## Security Checklist

- [ ] APP_DEBUG=false in production
- [ ] Strong database passwords
- [ ] SSL certificate installed
- [ ] Firewall configured (ufw)
- [ ] Regular security updates
- [ ] File permissions correct
- [ ] .env file not accessible
- [ ] Database backups automated
- [ ] Fail2ban configured
- [ ] Rate limiting enabled

## Performance Optimization

1. Enable OPcache
2. Use Redis for cache and sessions
3. Enable Gzip compression
4. Optimize database queries
5. Use CDN for static assets
6. Enable HTTP/2
7. Implement database indexing
8. Use queue workers for heavy tasks

## Support

For deployment issues:
- Check Laravel logs: `storage/logs/laravel.log`
- Check Nginx logs: `/var/log/nginx/`
- Check PHP-FPM logs: `/var/log/php8.2-fpm.log`
- Run: `php artisan about`
